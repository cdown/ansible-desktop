#!/bin/bash -e

# https://bit.ly/2omT14e

vars_file=/.ansiblevars
bp_file=/etc/apt/sources.list.d/backports.list

# HACK: this *must* be the same as in tasks/apt.yml. sigh, ansible doesn't
# support dynamic reconfigure.
if ! [[ -f $bp_file ]]; then
    echo 'deb http://ftp.debian.org/debian jessie-backports main' > "$bp_file"
    apt-get update
fi

if ! (( USE_CURRENT_CHECKOUT )); then
    apt-get -y install git
    apt-get -y -t jessie-backports install ansible

    playbook_dir=$(mktemp -ud)
    trap 'cd /; rm -rf "$playbook_dir"' 0

    git clone --recursive git://github.com/cdown/ansible-server.git \
        "$playbook_dir"

    # set -e is already set, so...
    # shellcheck disable=SC2164
    cd "$playbook_dir"
fi

if [[ $HOSTNAME == raspberrypi ]] && ! [[ -e $vars_file ]]; then
    read -r -p 'Pi-Fi SSID: ' ssid
    read -r -p 'Pi-Fi passphrase: ' pass
    cat > "$vars_file" << EOF
cap_ssid: "$ssid"
cap_pass: "$pass"
EOF
fi

ansible-playbook -i localhost, -v setup.yml
