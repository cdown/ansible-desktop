---
- name: Copy Pacman configuration
  copy: src=files/pacman.conf dest=/etc/pacman.conf
  register: pacman_conf

- name: Manual pacman repo update to sync new dbs
  command: pacman -Syy
  when: pacman_conf.changed

# Workaround to avoid https://github.com/ansible/ansible/issues/37334
- command: pacman -Qi base
  changed_when: False
  register: base_package_present
- command: pacman -S --noconfirm base
  when: base_package_present.rc != 0

- name: Install minimal base
  pacman:
    name:
      - base
      # These used to be part of the base group, but aren't part of the new
      # metapackage. After new `base` becomes stable, these should be moved to
      # relevant sections and justified there.
      - dhcpcd
      - less
      - linux-firmware
      - systemd-sysvcompat  # TODO: remove and just use init=...?
      - util-linux

- name: Remove unused OVH tools
  pacman:
    state: absent
    name:
      - ethtool
      - hddtemp
      - irqbalance
      - jfsutils
      - dmidecode
      - grub
      - man-pages-de
      - man-pages-it
      - net
      - screen
      - tcpdump
      - smartmontools
      - vlan
      - wget
      - gnu-efi-libs
      - bc
      - numactl
      - haveged
      - parted
      - bind
      - ntp

- name: Nuke motd
  copy: content="" dest=/etc/motd

- name: Install kernel + LTS as backup
  pacman:
    name:
      - '{{ kernel }}'
      - linux-lts

- name: Copy generate syslinux script
  copy: src=files/bin/generate-syslinux-config dest=/usr/local/bin/generate-syslinux-config mode=755

- name: Install packages needed for boot
  pacman:
    name:
      - syslinux
      - intel-ucode

- name: Generate syslinux config
  command: "generate-syslinux-config {{ kernel }} '{{ kernel_params }}'"
  register: gsc
  changed_when: false

- name: Copy syslinux config
  copy: 'content="{{ gsc.stdout }}\n" dest=/boot/syslinux/syslinux.cfg'

- name: Install syslinux to /boot
  command: syslinux-install_update -i -a -m
  changed_when: false

- name: Install tools
  pacman:
    name:
      - mosh
      - tmux
      - vim
      - ncdu

      # Environmental deps
      - btrfs-progs
      - zsh

      # upgrade
      - ansible
      - git
      - rsync

      # unite
      - lsof

      # pacdiff
      - pacman-contrib

- name: Enable systemd-timesyncd
  service: name=systemd-timesyncd state=started enabled=yes

- name: Enable dhcpcd
  service: name=dhcpcd state=started enabled=yes

- name: Script to update from ansible-server
  copy: src=files/bin/ansible-update dest=/usr/local/bin/ansible-update mode=755

- name: Set I/O schedulers
  template: src=files/io-schedulers.rules dest=/etc/udev/rules.d/99-io-schedulers.rules
